<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Who sm i 畫展</title>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#000; touch-action: none; }
    canvas { display:block; }
  </style>
</head>
<body>
  <canvas id="panorama"></canvas>

  <script>
    const canvas = document.getElementById('panorama');
    const ctx = canvas.getContext('2d');
    let width = canvas.width = window.innerWidth;
    let height = canvas.height = window.innerHeight;

    const img = new Image();
    img.src = 'images/pano.jpg'; // 放你的 iPhone 全景圖

    // 拖曳與偏移
    let offsetX = 0;
    let isDragging = false;
    let startX = 0;

    // 縮放
    let scale = 1;

    // 手機觸控防抖
    let lastTouchTime = 0;
    let touchStartX = 0;
    let initialDistance = 0;
    let initialScale = scale;

    img.onload = () => draw();

    function draw() {
      ctx.clearRect(0,0,width,height);

      const imgWidth = img.width * scale;
      const imgHeight = img.height * scale;

      // 水平偏移
      let x = -offsetX % imgWidth;
      if(x > 0) x -= imgWidth;

      // 垂直置中
      const yOffset = (height - imgHeight)/2;

      // 水平無縫繪製
      for(let i = x; i < width; i += imgWidth){
        ctx.drawImage(img, i, yOffset, imgWidth, imgHeight);
      }
    }

    // -----------------------------
    // 滑鼠拖曳
    // -----------------------------
    canvas.addEventListener('mousedown', e => {
      isDragging = true;
      startX = e.clientX;
    });
    canvas.addEventListener('mousemove', e => {
      if(!isDragging) return;
      const dx = e.clientX - startX;
      startX = e.clientX;
      offsetX -= dx;
      draw();
    });
    canvas.addEventListener('mouseup', () => isDragging=false);
    canvas.addEventListener('mouseleave', () => isDragging=false);

    // -----------------------------
    // 滾輪縮放（以游標為中心）
    // -----------------------------
    canvas.addEventListener('wheel', e => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const oldScale = scale;

      scale -= e.deltaY * 0.0015; // 調整縮放速度
      if(scale < 0.5) scale = 0.5;
      if(scale > 3) scale = 3;

      offsetX = (offsetX + mx)/oldScale*scale - mx;
      draw();
    });

    // -----------------------------
    // 雙擊縮放（以游標為中心）
    // -----------------------------
    canvas.addEventListener('dblclick', e => {
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const oldScale = scale;

      scale = (scale === 1) ? 2 : 1;
      offsetX = (offsetX + mx)/oldScale*scale - mx;
      draw();
    });

    // -----------------------------
    // 手機觸控滑動與捏合
    // -----------------------------
    canvas.addEventListener('touchstart', e => {
      if(e.touches.length === 1){
        touchStartX = e.touches[0].clientX;
        lastTouchTime = Date.now();
      } else if(e.touches.length === 2){
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        initialDistance = Math.sqrt(dx*dx + dy*dy);
        initialScale = scale;
      }
    });

    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      if(e.touches.length === 1){
        const now = Date.now();
        if(now - lastTouchTime < 16) return; // 防抖
        lastTouchTime = now;

        const dx = e.touches[0].clientX - touchStartX;
        touchStartX = e.touches[0].clientX;
        offsetX -= dx;
        draw();
      } else if(e.touches.length === 2){
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const distance = Math.sqrt(dx*dx + dy*dy);

        scale = initialScale * (distance / initialDistance);
        if(scale < 0.5) scale = 0.5;
        if(scale > 3) scale = 3;

        draw();
      }
    });

    canvas.addEventListener('touchend', e => {
      if(e.touches.length < 2) {
        initialDistance = 0;
        initialScale = scale;
      }
    });

    // -----------------------------
    // 視窗大小調整
    // -----------------------------
    window.addEventListener('resize', () => {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
      draw();
    });
  </script>
</body>
</html>
